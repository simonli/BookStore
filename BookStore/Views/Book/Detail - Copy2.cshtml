@using System.Linq
@using BookStore
@using Microsoft.Extensions.Options
@inject IOptions<AppSettings> AppSettings
@inject BookUtil BookUtil
@model BookDetailViewModel

@{
    ViewData["Title"] = Model.Book.Title;
    var book = Model.Book;
    var relatedBooks = Model.RelatedBooks;
    var amazonCode = AppSettings.Value.AmazonCode;
    var logoUrl = BookUtil.GetBookLogo(book.Logo);
}


<div class="row">
    <div class="col-md-10">
        <div class="well well-lg">
            <h1>
                <a>
                    @book.Title
                </a>
            </h1>
            <p>
                <span>
                    作者：<a>
                        <strong>@book.Author</strong>
                    </a>
                </span>
                @{
                    if (!string.IsNullOrEmpty(book.Translator))
                    {
                        <span>
                            译者：<a>
                                <strong>@book.Translator</strong>
                            </a>
                        </span>
                    }
                    if (!string.IsNullOrEmpty(book.Publisher))
                    {
                        <span>
                            <a>
                                <small>@book.Publisher</small>
                            </a>
                        </span>
                    }
                }
            </p>
            <div>
                @{
                    if (book.DoubanRatingScore > 0 || book.DoubanRatingPeople > 0)
                    {
                        @:豆瓣：
                        if (book.DoubanRatingScore > 0)
                        {
                            <span class="badge text-success">@(book.DoubanRatingScore)分</span>
                        }
                        if (book.DoubanRatingPeople > 0)
                        {
                            <a href="@book.DoubanUrl" target="_blank">(@(book.DoubanRatingPeople)人评价...)</a>
                        }
                    }
                }
                <a class="btn btn-primary pull-right" title="到亚马逊购买正版">
                    <i class="fa fa-amazon" aria-hidden="true"></i> 购买正版
                </a>
                <div class="clearfix"></div>
            </div>

            <div class="row">
                <ul id="book-detail-tabs" class="nav nav-tabs">
                    <li class="active">
                        <a href="#book-summary" data-toggle="tab">内容简介</a>
                    </li>
                    <li>
                        <a href="#book-catalog" data-toggle="tab">目录列表</a>
                    </li>
                    <li>
                        <a href="#book-author-intro" data-toggle="tab">作者介绍</a>
                    </li>
                </ul>
                <div id="book-detail-tabscontent" class="tab-content">
                    <div class="tab-pane active" id="book-summary">
                        <a href="#" target="_blank" class="pull-right" title="购买正版...">
                            <img src="@logoUrl" alt="@(book.Title)" class="book-img"/>
                        </a>
                        <div>
                            @Html.Raw(book.BookSummary)
                            <div class="clearfix"></div>
                        </div>
                    </div><!-- book-summary end -->
                    <div class="tab-pane fade" id="book-catalog">
                        @Html.Raw(book.BookCatalog)
                        <div class="clearfix"></div>
                    </div> <!-- book-catalog end -->
                    <div class="tab-pane fade" id="book-author-intro">
                        <div>
                            @Html.Raw(book.AuthorSummary)
                            <div class="clearfix"></div>
                        </div>
                    </div><!-- author-summary end -->
                </div>
            </div><!-- book detail end -->
            <div class="row">
                @{
                    if (relatedBooks.Count > 0)
                    {
                        <h5>类似书籍</h5>
                        <ul class="list-inline well" id="ralted-books">
                            @foreach (var rb in relatedBooks)
                            {
                                <li>
                                    <a asp-action="Detail" asp-route-id="@rb.Id">
                                        <img class='book-img' src="@BookUtil.GetBookLogo(rb.Logo)" title="@rb.Title" alt="@rb.Title"/>
                                    </a>
                                </li>
                            }
                        </ul>
                    }
                }

            </div><!-- related books end -->
            <div class="row">
                @{
                    if (book.BookTags.Count > 0)
                    {
                        <ul class="list-inline well">
                            @foreach (var bookTag in book.BookTags)
                            {
                                <li>
                                    <a asp-controller="Book" asp-action="Tag" asp-route-id="@bookTag.TagId">@bookTag.Tag.Name</a>
                                </li>
                            }
                        </ul>
                    }
                }
            </div><!-- Book tags end -->
            <div class="row">
                <hr>
                <h5>
                    <vc:user-action></vc:user-action>
                </h5>
                <hr>
            </div><!-- User Operation Log end -->
            <div class="row">
                <a asp-action="FileUpload" asp-route-id="@book.Id" class="btn btn-primary pull-right">
                    <i class="fa fa-upload" aria-hidden="true"></i>上传新版本
                </a>
                <h4>@(book.BookEditions.Count)个版本: </h4>
            </div><!-- editions count end -->
            <div class="row">
                <ul class="list-unstyled">
                    @{
                        var bookEdtions = book.BookEditions.OrderBy(x => x.CreateTime);
                        foreach (var be in bookEdtions)
                        {
                            <li id="@be.Id" pk="@be.Id">
                                <hr/>
                                <div>
                                    <a asp-action="Edition" asp-route-id="@be.Id" class="pull-right">
                                        <small>@(be.BookEditionComments.Count)条评论</small>
                                        <i class="fa fa-comment"></i>
                                    </a>
                                    <span class="badge" title="md5:@be.CheckSum">@Utils.FormatFileSize(be.Filesize)</span>
                                    <a asp-action="Edition" asp-route-id="@be.Id">
                                        <span class="badge" title="@be.OriginalFilename">@be.OriginalFilename</span>
                                    </a>
                                </div>
                                <div>
                                    <small>
                                        @Utils.FormatDateTime(be.CreateTime), 上传者:
                                        <a asp-controller="Account" asp-action="ProfileEdition" asp-route-username="@be.User.Username">
                                            @be.User.Username
                                        </a>
                                    </small>
                                </div>
                                <div class="btn-toolbar">
                                    <vc:pushmail book-edition="@be"></vc:pushmail>
                                </div>
                                @{
                                    var becs = be.BookEditionComments.OrderBy(x => x.CreateTime);
                                    foreach (var bec in becs)
                                    {
                                        <div class="row-fluid">
                                            <a asp-controller="Account" asp-action="ProfileComment" asp-route-username="@bec.User.Username">
                                                <img class='pull-left img-circle avatar-small' src="@await Component.InvokeAsync("AvatarUrl", bec.User)"/>@bec.User.Username
                                            </a>:
                                            <small class="muted">
                                                <a asp-action="Edition" asp-route-id="@bec.BookEdition.Id" asp-fragment="@bec.Id">@bec.Comment</a>
                                            </small>
                                        </div>
                                    }
                                }<!-- comment end -->
                                <form asp-action="Edition" asp-route-id="@be.Id" asp-route-next=@Url.Action("Detail", new {id = book.Id, fragment = be.Id}) class="form-inline">
                                    <input type="text" class="form-control" name="comment-short"  maxlength="80" placeholder="发表评论，勾选[举报]将通知管理员" />
                                    <label for="id_is_report">
                                        举报<input id="id_is_report" type="checkbox" name="is_report">
                                    </label>
                                    <button class="btn" type="submit" title="发表评论">
                                        <i class="fa fa-comment-o"></i>
                                    </button>
                                </form>
                            </li>
                            <!-- each edition and comment end -->
                        }
                    }
                </ul>
            </div><!-- edition and comment end -->


        </div><!-- well end -->
    </div>
</div>